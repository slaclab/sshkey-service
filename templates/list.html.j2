<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
</head>
<body>
    <h1>{{ username }}</h1>

    <p>Register new public key: <button onclick="window.location.href='/register/{{ username }}'" class="register">Register</button></p>

    {% if no_expiry %}
    <p>SSH key expiry disabled</p>
    {% endif %}

    <table id="mykeys">
    <tr>
        <th>finger print</th>
        <th>is_active</th>
        <th>created_at</th>
        <th>source_ip</th>
        <th>valid_until</th>
    {% if not no_expiry %}
        <th>expires_at</th>
    {% endif %}
        <th>action</th>
    </tr>
{% for key in keys %}
    <tr data-fingerprint="{{ key['finger_print'] }}">

    <td>
{{ key['finger_print'] }}
    </td>
    <td>
{% if key['is_active'] == "1" %}✅{% else %}❌{% endif %}
    </td>
    <td class="datetime" data-utc="{{ key['created_at'] }}">
{{ key['created_at'] }}
    </td>
    <td>
{{ key['source_ip'] }}
    </td>
    <td class="datetime" data-utc="{{ key['valid_until'] }}">
{{ key['valid_until'] }}
    </td>
{% if not no_expiry %}
    <td class="datetime" data-utc="{{ key['expires_at'] }}">
{{ key['expires_at'] }}
    </td>
{% endif %}
    <td>
    <button class="refresh">Refresh</button>
    <button class="inactivate">Inactivate</button>
    </td>




    </tr>
{% endfor %}
    </table>

<script type="text/javascript">
    const username = "{{ username }}";

    const fpoperation = function(url, method) {
        fetch(url, { "method": method })
        .then(response => {
            if (response.ok) {
              return response.text();
            } else {
              throw new Error(`Server error: ${response.status}`);
            }
        })
        .then(data => {
            console.log("Reloading the page");
            window.location.reload();
        })
        .catch(error => {
            alert('Fetch error:', error);
        })
    }

    document.querySelectorAll(".refresh").forEach((el) => el.addEventListener("click", (ev) => {
        const fingerprint = ev.currentTarget.closest("tr").getAttribute("data-fingerprint");
        fpoperation(`../refresh/${username}/${fingerprint}`, "PATCH");
    }))
    document.querySelectorAll(".inactivate").forEach((el) => el.addEventListener("click", (ev) => {
        const fingerprint = ev.currentTarget.closest("tr").getAttribute("data-fingerprint");
        fpoperation(`../inactivate/${username}/${fingerprint}`, "DELETE");
    }))

    const padNumber = (value) => String(value).padStart(2, "0");

    const formatDateToLocal = (raw) => {
        if (!raw) {
            return "";
        }
        const normalized = raw.includes("T") ? raw : raw.replace(" ", "T");
        const date = new Date(normalized);
        if (isNaN(date)) {
            const fallback = raw.split(".")[0].replace("T", " ");
            return fallback;
        }
        const year = date.getFullYear();
        const month = padNumber(date.getMonth() + 1);
        const day = padNumber(date.getDate());
        const hours = padNumber(date.getHours());
        const minutes = padNumber(date.getMinutes());
        const seconds = padNumber(date.getSeconds());
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
    };

    document.querySelectorAll("td[data-utc]").forEach((el) => {
        const formatted = formatDateToLocal(el.getAttribute("data-utc"));
        el.textContent = formatted;
    });
</script>
</html>
